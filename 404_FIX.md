# 404 Not Found Fix

## Issues Identified and Fixed

### 1. Missing Route Rewrites in vercel.json

**Problem:** The rewrite patterns in `vercel.json` were missing exact matches for base routes.

**Example:**
- `/events/(.*)` matches `/events/123` but NOT `/events` (because `(.*)` requires at least one character)
- `/checkout/(.*)` matches `/checkout/sessions` but NOT `/checkout`
- `/admin/(.*)` matches `/admin/events` but NOT `/admin`

**Fix:** Added explicit rewrites for base routes:
```json
{
  "source": "/events",
  "destination": "/api/index"
},
{
  "source": "/events/(.*)",
  "destination": "/api/index"
}
```

### 2. Added Request Logging

**Problem:** No visibility into what requests are being received by the Express app.

**Fix:** Added debug middleware to log all incoming requests:
- Logs method, path, URL, and query parameters
- Helps identify routing issues in Vercel logs

### 3. Enhanced 404 Handler

**Problem:** 404 errors didn't provide enough information for debugging.

**Fix:** Enhanced 404 handler to log:
- Request method
- Path, URL, originalUrl, baseUrl
- Returns detailed error response for debugging

## How Vercel Rewrites Work

When Vercel receives a request:
1. It matches the request against rewrite rules in `vercel.json`
2. If matched, it forwards the request to the destination (e.g., `/api/index`)
3. **Important:** The original path is preserved in `req.path` and `req.originalUrl`
4. Express routes must match the original path, not the rewrite destination

**Example:**
- Request: `GET /health`
- Vercel rewrite: `/health` → `/api/index`
- Express receives: `req.path = '/health'`, `req.originalUrl = '/health'`
- Express route: `app.use('/health', healthRouter)` matches ✅

## Testing the Fix

After deploying, test these endpoints:

1. **Health Check:**
   ```bash
   curl https://your-domain.vercel.app/health
   ```

2. **Events List:**
   ```bash
   curl https://your-domain.vercel.app/events
   ```

3. **Metrics:**
   ```bash
   curl https://your-domain.vercel.app/metrics
   ```

4. **Check Vercel Function Logs:**
   - Go to Vercel Dashboard → Your Project → Functions
   - Check the logs for the request logging output
   - Look for any import errors or routing issues

## Common 404 Causes

1. **Route not in vercel.json rewrites** - Add the route pattern
2. **Rewrite pattern doesn't match** - Check regex patterns
3. **Express route doesn't match** - Verify route mounting in `src/index.ts`
4. **Module import failure** - Check Vercel build logs for TypeScript errors
5. **Path mismatch** - Verify `req.path` matches Express route patterns

## Debugging Steps

1. **Check Vercel Build Logs:**
   - Look for TypeScript compilation errors
   - Check for "Cannot find module" errors
   - Verify the function builds successfully

2. **Check Vercel Function Logs:**
   - Look for the request logging output
   - Check for 404 warnings with path information
   - Look for any error messages

3. **Test Locally with Vercel CLI:**
   ```bash
   vercel dev
   ```
   This simulates the Vercel environment locally

4. **Verify Route Matching:**
   - Check that the rewrite pattern in `vercel.json` matches your request
   - Verify the Express route is mounted correctly
   - Ensure the route path matches what Express receives

## Files Modified

1. **vercel.json** - Added explicit rewrites for base routes
2. **src/index.ts** - Added request logging middleware and enhanced 404 handler

## Next Steps

If you're still getting 404 errors:

1. Check Vercel function logs for the request logging output
2. Verify the path in the logs matches your Express routes
3. Check if there are any import errors in the build logs
4. Test with `vercel dev` locally to reproduce the issue
5. Verify all environment variables are set correctly

